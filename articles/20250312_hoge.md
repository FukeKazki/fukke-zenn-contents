---
title: "Firebase Auth ã‚»ãƒƒã‚·ãƒ§ãƒ³ Cookieã‚’åˆ©ç”¨ã—ãŸèªè¨¼ã‚’NextJSã«çµ„ã¿è¾¼ã‚€"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firebase"]
published: false
---

## ã¯ã˜ã‚ã«
Firebase Authã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹éš›ã«ã€èªè¨¼æƒ…å ±ã‚’Server Componentsã‹ã‚‰åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## è¦ç´„

### æ§‹æˆ
èªè¨¼ç”¨ãƒšãƒ¼ã‚¸ã¨èªè¨¼å¾Œã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹æƒ³å®šã§ã™ã€‚

```
/
â”œâ”€ app
â”‚  â”œâ”€ auth
â”‚  â””â”€ dashboard
â””â”€ middleware.ts
```

### 1. ã‚µã‚¤ãƒ³ã‚¤ãƒ³
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§Firebase Authã‚’åˆ©ç”¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ã—ã¾ã™ã€‚
ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã¨`idToken`ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚

```tsx:auth/page.tsx
const handleSubmit = async (input) => {
  const userCredential = await signInWithEmailAndPassword(getAuth(), input.email, input.password)
  const idToken = await userCredential.user.getIdToken()

  await startSessionAction(idToken)
}
```

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹

å–å¾—ã—ãŸ`idToken`ã‚’serverActionã«é€ã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã®ä½œæˆã¨ã‚»ãƒƒãƒˆã‚’ã—ãŸå¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚

```ts:actions.ts
export async function startSessionAction(
  firebaseIdToken: FirebaseIdToken,
) {
  const sessionCookie = await createSessionCookie(firebaseIdToken)

  setSessionCookieToCookie(await cookies(), sessionCookie)

  const path = '/dashboard'
  redirect(path)
}
```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã®ä½œæˆã«ã¯`firebase-admin`ã®`auth`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

:::details
```ts
import { auth } from 'firebase-admin'

export const SESSION_COOKIE_KEY_NAME = '__session'
export const SESSION_COOKIE_MAX_AGE_SEC = 86400 * 7 // 7days in seconds

export function createSessionCookie(firebaseIdToken: FirebaseIdToken) {
  return auth.createSessionCookie(firebaseIdToken, {
    expiresIn: SESSION_COOKIE_MAX_AGE_SEC * 1000
  })
}

export function setSessionCookieToCookie(
  cookies: ReadonlyRequestCookies | RequestCookies | ResponseCookies,
  sessionCookie: SessionCookie
) {
  cookies.set({
    name: SESSION_COOKIE_KEY_NAME,
    value: sessionCookie,
    maxAge: SESSION_COOKIE_MAX_AGE_SEC,
    httpOnly: true,
    secure: true,
    sameSite: 'strict'
  })
}
```
:::

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä½œæˆ

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§è¡Œãªã†ã“ã¨ã‚’å›³è§£ã—ã¾ã™ã€‚
ã©ã¡ã‚‰ã‚‚èªè¨¼çŠ¶æ…‹ã‚’è¦‹ã¦æœªèªè¨¼ã§ã‚ã‚Œã°èªè¨¼ãƒšãƒ¼ã‚¸ã¸ã€èªè¨¼æ¸ˆã¿ã§ã‚ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚

```mermaid
graph TD
    subgraph "/auth ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹"
        A1[Request to /auth] --> C[Run authPageMiddleware]
        C -->|Has next-action header| D1[Pass with NextResponse.next]
        C -->|No next-action header| E{Auth Required?}
        E -->|Yes| D1
        E -->|No| F[Redirect to /dashboard]
    end

    subgraph "ãã®ä»–ã®ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹"
        A2[Request to other paths] --> G{Has Session Cookie?}
        G -->|No| H[Redirect to /auth/login]
        G -->|Yes| I[Run verifySessionCookie]
        I -->|Auth Failed| J[Redirect to /auth/login]
        I -->|Auth Success| D2[Pass with NextResponse.next]
    end

    style A1 fill:#f9f,stroke:#333
    style A2 fill:#f9f,stroke:#333
```

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«é–¢ã™ã‚‹å®Ÿè£…ã¯é•·ããªã‚‹ã®ã§ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã«è©°ã‚ã¦ãŠãã¾ã™ã€‚

:::details middleware.ts
```ts:middleware.ts
export async function authMiddleware(req: NextRequest) {
  if (req.nextUrl.pathname.startsWith('/api')) {
    return NextResponse.next()
  }

  // /auth ã®å ´åˆ
  if (req.nextUrl.pathname.startsWith('/auth')) {
    return await authPageMiddleware(req)
  }

  const sessionCookie = extractSessionCookie(req.cookies)
  if (!sessionCookie) {
    console.error('session cookie not found')

    const redirectTo = encodeURIComponent(
      `${req.nextUrl.pathname}${req.nextUrl.search}${req.nextUrl.hash}`
    )
    return NextResponse.redirect(
      new URL(
        `/auth/login?error-code=SESSION_COOKIE_NOT_FOUND&redirectTo=${redirectTo}`,
        req.nextUrl
      )
    )
  }

  const verifiedPayload = await verifySessionCookie(sessionCookie)
  if (verifiedPayload instanceof TaggedError) {
    console.error(verifiedPayload)

    const redirectTo = encodeURIComponent(
      `${req.nextUrl.pathname}${req.nextUrl.search}${req.nextUrl.hash}`
    )
    return NextResponse.redirect(
      new URL(`/auth/login?error-code=${verifiedPayload.tag}&redirectTo=${redirectTo}`, req.nextUrl)
    )
  }

  return NextResponse.next()
}

async function authPageMiddleware(req: NextRequest) {
  // server action ã®å ´åˆã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®ã¾ã¾é€šã™
  if (req.headers.has('next-action')) {
    return NextResponse.next()
  }

  const shouldAuthenticate = await checkShouldAuthenticate(req)

  if (shouldAuthenticate) {
    // èªè¨¼ãŒå¿…è¦ãªã¨ãã¯ãã®ã¾ã¾é€šã™
    return NextResponse.next()
  } else {
    // èªè¨¼ãŒä¸è¦ãªã¨ãã¯/ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
  }
}
```
:::





## ã¾ã¨ã‚

## å‚è€ƒæ–‡çŒ®
- [ã‚»ãƒƒã‚·ãƒ§ãƒ³ Cookie ã‚’ç®¡ç†ã™ã‚‹  |  Firebase Authentication](https://firebase.google.com/docs/auth/admin/manage-cookies?hl=ja)
- [firebase auth ã§ cookie ã§ã® session ç®¡ç†è©¦ã™](https://zenn.dev/nbstsh/scraps/7acd43e3e8116e)
