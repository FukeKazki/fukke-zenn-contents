---
title: "Supabaseã®æ©Ÿèƒ½"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
publication_name: "yoshinani_dev"
---

## ã¯ã˜ã‚ã«

æ–°è¦é–‹ç™ºã§Supabaseã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚
NextJSã‹ã‚‰ã®Supabaseåˆ©ç”¨ã«ã¤ã„ã¦ç°¡å˜ã«ç´¹ä»‹ã—ã¾ã™ã€‚

## è¦ç´„

- Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã€Server Actionsã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§æ‰±ãˆã‚‹
- Supabase Auth: ãƒ¡ãƒ¼ãƒ«ã‚³ãƒ¼ãƒ‰èªè¨¼ãŒç°¡å˜ã«å®Ÿè£…å¯èƒ½
- Supabase DB: ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆãŒç°¡å˜ã«å®Ÿç¾å¯èƒ½

## NextJSé€£æº

<https://supabase.com/docs/guides/auth/server-side/nextjs> ã®ã‚¬ã‚¤ãƒ‰ã«å¾“ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

ã‚µãƒ¼ãƒãƒ¼å´ã§æ‰±ãˆã‚‹ã‚³ãƒ¼ãƒ‰ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ‰±ãˆã‚‹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†ã‘ã¦ä½œæˆã§ãã€ãã‚Œãã‚Œã‚’Server Actionsã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§åˆ©ç”¨ã§ãã¾ã™ã€‚

## èªè¨¼

Supabase Authenticationã‚’ä½¿ã£ã¦èªè¨¼ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

![èªè¨¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±](https://storage.googleapis.com/zenn-user-upload/41af6f3a6503-20241125.png)
***èªè¨¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±***
ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```tsx:form.tsx
<form>
  <label htmlFor="email">Email:</label>
  <input id="email" name="email" type="email" required />
  <label htmlFor="password">Password:</label>
  <input id="password" name="password" type="password" required />
  <Button formAction={signin}>Sign in</Button>
  <Button formAction={signup}>Sign up</Button>
</form>
```

ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ä¾‹ã€‚
`signUp`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```ts:signup.ts
"use server";

export async function signup(formData: FormData) {
  const supabase = await createClient();

  const data = {
    email: formData.get("email") as string,
    password: formData.get("password") as string,
  };

  const { error } = await supabase.auth.signUp(data);

  if (error) {
    redirect("/error");
  }

  revalidatePath("/", "layout");
  redirect("/login/organization");
}
```

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®ä¾‹ã€‚
`signInWithPassword`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã™ã€‚

```ts:signin.ts
"use server";

export async function signin(formData: FormData) {
  const supabase = await createClient();

  const data = {
    email: formData.get("email") as string,
    password: formData.get("password") as string,
  };

  const { error } = await supabase.auth.signInWithPassword(data);

  if (error) {
    redirect("/error");
  }

  revalidatePath("/", "layout");
  redirect("/");
}
```

### Tips

Emailèªè¨¼ã®è¨­å®šé …ç›®ã§Confirm Emailã‚’ONã«ã™ã‚‹ã¨ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‰ã«ãƒ¡ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰èªè¨¼ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

![Emailèªè¨¼è¨­å®š](https://storage.googleapis.com/zenn-user-upload/dc80a84f7768-20241125.png)
***Emailèªè¨¼è¨­å®š***

![å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«](https://storage.googleapis.com/zenn-user-upload/0f0229997d6a-20241126.png)
***å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«***

## DB

Supabaseã§ã®DBã¸ã®ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã€å–å¾—ã«ã¤ã„ã¦è¦‹ã¦ãã¾ã™ã€‚

![ERå›³](https://storage.googleapis.com/zenn-user-upload/8e56bfba6af1-20241125.png)
***ERå›³***

### ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥

ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥å¾Œã«å–å¾—ã—ãŸã„å ´åˆã¯select()ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```ts
export const createOrganization = async (data: any) => {
  const supabase = await createClient();
  return supabase
    .from("organization")
    .insert({ ...data })
    .select()
    .single(); 
};
```

### ãƒ‡ãƒ¼ã‚¿å–å¾—

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ã„ãŸçµ„ç¹”æƒ…å ±ã‚’å–å¾—ã™ã‚‹ä¾‹ã§ã™ã€‚ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆã‚’è‡ªå‹•ã§è¡Œã£ã¦ãã‚Œã¾ã™ã€‚

```ts
export const getOrganizations = async () => {
  const supabase = await createClient();
  const authUser = await supabase.auth.getUser();
  const user = await supabase
    .from("user")
    .select("*")
    .eq("auth_id", authUser.data.user?.id)
    .single();

  // many to many relationship
  const organizations = await supabase
    .from("user")
    .select(`* , organization(*)`)
    .eq("id", user.data.id)
    .single();

  return organizations;
};
```

## ãŠã‚ã‚Šã«

Supabaseã®æ©Ÿèƒ½ã«ã¤ã„ã¦ç°¡å˜ã«è¦‹ã¦ãã¾ã—ãŸã€‚
å€‹äººçš„ã«ã¯Firebaseã«æ¯”è¼ƒã—ã¦ã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ³ãƒ—ãƒ«ã§æ›¸ãã‚„ã™ãé­…åŠ›çš„ã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
NextJSã¨ã®ç›¸æ€§ã‚‚è‰¯ãã€ä»Šå¾Œç©æ¥µçš„ã«æ¡ç”¨ã—ã¦ã„ããŸã„ã§ã™ã€‚
