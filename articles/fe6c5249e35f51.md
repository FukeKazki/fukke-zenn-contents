---
title: "ã‚ªãƒ•ã‚£ã‚¹ã®CO2æ¿ƒåº¦ã‚’è¨ˆæ¸¬ã—ã¦ã€é›†ä¸­æ™‚é–“ã‚’å¢—ã‚„ã™"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["iot"]
publication_name: "yoshinani_dev"
published: false
---

## ã¯ã˜ã‚ã«

å®¤å†…ã®CO2æ¿ƒåº¦ã¯ä½œæ¥­åŠ¹ç‡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ãŒã€æ—¥å¸¸çš„ã«ã“ã‚Œã‚’æ„è­˜ã—ã¦æ›æ°—ã‚’ã—ã¦ã„ã‚‹äººã¯å¤šãã‚ã‚Šã¾ã›ã‚“ã€‚

ç©ºæ°—ä¸­ã®CO2æ¿ƒåº¦ã¯ãŠãŠã‚ˆã410ppmç¨‹åº¦ã€å®¤å†…ã¯å»ºç¯‰ç‰©è¡›ç”Ÿæ³•ã«ã‚ˆã‚Š1000ppmä»¥ä¸‹ãŒåŸºæº–ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚éƒ¨å±‹ã®æ¿ƒåº¦ãŒé«˜ããªã‚‹ã¨æ¯è‹¦ã—ã•ã‚„çœ æ°—ãªã©ã®ç—‡çŠ¶ãŒå‡ºã¦ãã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ä½œæ¥­éƒ¨å±‹ã®CO2æ¿ƒåº¦ã‚’å¯è¦–åŒ–ã—ã€ä½œæ¥­ã¸é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ã—ãŸå–ã‚Šçµ„ã¿ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚æ¿ƒåº¦ã®ä¸Šæ˜‡ã‚’é€šçŸ¥ã—ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ›æ°—ã™ã‚‹ã“ã¨ã§ã€é›†ä¸­ã‚’æŒç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/acc97b0981cd-20260209.png)

## å…¨ä½“æ§‹æˆ

**å‰ææ¡ä»¶**ï¼šNode.jsï¼ˆv18ä»¥ä¸Šæ¨å¥¨ï¼‰ã€SwitchBotã‚¢ãƒ—ãƒªã€Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå¿…è¦ã§ã™ã€‚ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ã€SwitchBotã®APIãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€Slackã®Incoming Webhook URLã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚

CO2ã‚»ãƒ³ã‚µãƒ¼ã«ã¯SwitchBotã®è£½å“ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚
ã¾ãŸã€SwitchBot APIã‹ã‚‰CO2ã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ãƒãƒ–ãƒŸãƒ‹ã‚‚åˆ©ç”¨ã—ã¾ã—ãŸã€‚

[SwitchBot CO2 ã‚»ãƒ³ã‚µãƒ¼ï½œç©ºæ°—ç®¡ç†ã‚’ã‚¹ãƒãƒ¼ãƒˆã« â€“ SwitchBot (ã‚¹ã‚¤ãƒƒãƒãƒœãƒƒãƒˆ)](https://www.switchbot.jp/products/switchbot-co2-meter)
![CO2ã‚»ãƒ³ã‚µãƒ¼](https://storage.googleapis.com/zenn-user-upload/3dcd77a150df-20260127.jpeg)

[SwitchBot ãƒãƒ–ãƒŸãƒ‹ï½œãƒªãƒ¢ã‚³ãƒ³ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã‚‹ã‚¹ãƒãƒ¼ãƒˆãƒªãƒ¢ã‚³ãƒ³ â€“ SwitchBot (ã‚¹ã‚¤ãƒƒãƒãƒœãƒƒãƒˆ)](https://www.switchbot.jp/products/switchbot-hub-mini)
![å£é¢ã¸è¨­ç½®ã—ãŸãƒãƒ–ãƒŸãƒ‹](https://storage.googleapis.com/zenn-user-upload/7f9ed3589658-20260127.jpeg)

é€šçŸ¥å…ˆã¯Slackã«ã—ã¾ã—ãŸã€‚
ç­†è€…ã®PCï¼ˆMacï¼‰ä¸Šã§cronã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€å®šæœŸçš„ã«CO2æ¿ƒåº¦ã‚’å–å¾—ãƒ»é€šçŸ¥ã—ã¾ã™ã€‚

```mermaid
flowchart LR
  Sensor[CO2ã‚»ãƒ³ã‚µãƒ¼] -- è¨ˆæ¸¬å€¤ --> API[SwitchBot API]
  API -- å–å¾— --> Cron[cronã‚¹ã‚¯ãƒªãƒ—ãƒˆ]
  Cron -- é€šçŸ¥ --> Slack[Slack]
```

## SwitchBot API ã®æ¦‚è¦

https://github.com/OpenWonderLabs/SwitchBotAPI

æœ€åˆã«ã€SwitchBotã®ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‹ã‚‰APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

<!-- textlint-disable ja-technical-writing/no-mix-dearu-desumasu -->
1. SwitchBotã‚¢ãƒ—ãƒªã‚’é–‹ãã€ã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€â†’ã€Œè¨­å®šã€ã«ç§»å‹•ã—ã¾ã™
2. ã€Œã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚’10å›é€£ç¶šã§ã‚¿ãƒƒãƒ—ã—ã¾ã™
3. ã€Œé–‹ç™ºè€…å‘ã‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
4. ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã€ã¨ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ã‚’å–å¾—ã—ã¾ã™
<!-- textlint-enable ja-technical-writing/no-mix-dearu-desumasu -->

å–å¾—ã—ãŸAPIãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’åˆ©ç”¨ã—ã¦ã€èªè¨¼ã—ã¾ã™ã€‚

```ts:SwitchBot APIã‚’å©ãæ±ç”¨é–¢æ•°
import crypto from "node:crypto";
import env from "~/env.ts"

async function fetchSwitchBotAPI({ endpoint }: { endpoint: string }) {
  const url = `https://api.switch-bot.com/v1.1${endpoint}`;
  const t = Date.now();
  const nonce = crypto.randomUUID();
  const stringToSign = `${env.token}${t}${nonce}`;
  const sign = crypto
    .createHmac("sha256", env.secret)
    .update(stringToSign)
    .digest("base64");

  const response = await fetch(url, {
    method: "GET",
    headers: {
      Authorization: env.token,
      "Content-Type": "application/json; charset=utf8",
      t: t.toString(),
      sign,
      nonce,
    },
  });

  return response.json();
}
```

æ¬¡ã«ã€CO2ã‚»ãƒ³ã‚µãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹IDã‚’èª¿ã¹ã‚‹ãŸã‚ã«ã€SwitchBotã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

```ts:SwitchBotã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§
export async function getDeviceList() {
  const result = await fetchSwitchBotAPI({
    endpoint: "/devices",
  });
  console.debug(result)
}
```

æ¥ç¶šã•ã‚Œã¦ã„ã‚‹CO2ã‚»ãƒ³ã‚µãƒ¼ã¨ãƒãƒ–ãƒŸãƒ‹ã®deviceIdãŒå–å¾—ã§ãã¾ã—ãŸã€‚

```json:çµæœ
{
  "statusCode": 100,
  "body": {
    "deviceList": [
      {
        "deviceId": "*********",
        "deviceName": "CO2ã‚»ãƒ³ã‚µãƒ¼ï¼ˆæ¸©æ¹¿åº¦è¨ˆï¼‰ AF",
        "deviceType": "MeterPro(CO2)",
        "enableCloudService": true,
        "hubDeviceId": ""
      },
      {
        "deviceId": "*********",
        "deviceName": "ãƒãƒ–ãƒŸãƒ‹ 69",
        "deviceType": "Hub Mini",
        "enableCloudService": false,
        "hubDeviceId": ""
      }
    ],
    "infraredRemoteList": []
  },
  "message": "success"
}
```

æ¬¡ã«ã€å–å¾—ã—ãŸãƒ‡ãƒã‚¤ã‚¹IDã‚’æŒ‡å®šã—ã€ç¾åœ¨ã®CO2ã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚

```ts:ãƒ‡ãƒã‚¤ã‚¹ã‚’æŒ‡å®šã—ã¦ã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’å–å¾—ã™ã‚‹
export async function getDeviceStatus(deviceId: string) {
  const result = await fetchSwitchBotAPI({
    endpoint: `/devices/${deviceId}/status`,
  });
  console.debug(result);
}
```

çµæœã‹ã‚‰ã€æ°—æ¸©24.4â„ƒã€æ¹¿åº¦24%ã€CO2æ¿ƒåº¦646ppmã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```json:çµæœ
{
  "statusCode": 100,
  "body": {
    "version": "V1.8",
    "temperature": 24.4,
    "battery": 92,
    "humidity": 24,
    "CO2": 646,
    "deviceId": "************",
    "deviceType": "MeterPro(CO2)",
    "hubDeviceId": "DDCC52FA5669"
  },
  "message": "success"
}
```

## é€šçŸ¥è¨­è¨ˆ

æ¬¡ã«ã€å–å¾—ã—ãŸã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’Slackã«é€šçŸ¥ã™ã‚‹éƒ¨åˆ†ã‚’ä½œæˆã—ã¾ã™ã€‚
Slack Botã‚’ä½œæˆã—ã¦Incoming Webhookã‚’è¨­å®šã—ã€é€šçŸ¥ã—ã¾ã™ã€‚

**é€šçŸ¥ã®é–¾å€¤**ï¼šå»ºç¯‰ç‰©è¡›ç”Ÿæ³•ã®åŸºæº–ï¼ˆ1000ppmä»¥ä¸‹ï¼‰ã‚’å‚è€ƒã«ã€CO2æ¿ƒåº¦ãŒ1000ppmã‚’è¶…ãˆãŸæ™‚ç‚¹ã§é€šçŸ¥ã™ã‚‹ã‚ˆã†è¨­å®šã—ã¾ã—ãŸã€‚é–¾å€¤ã¯ä½œæ¥­ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š800ppmã§ã€Œæ›æ°—ã‚’æ¤œè¨ã€ã€1000ppmã§ã€Œæ›æ°—æ¨å¥¨ã€ãªã©ï¼‰ã€‚

é€šçŸ¥ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```ts:webhookã§é€šçŸ¥ã™ã‚‹é–¢æ•°
export interface CO2Data {
  deviceId: string;
  deviceName: string;
  co2: number;
  temperature: number;
  humidity: number;
  battery: number;
  timestamp: string;
}

export async function notifySlackWebhook(data: CO2Data): Promise<void> {
  const response = await fetch(env.slackWebhookUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      text: `ğŸŸ¡ CO2æ¿ƒåº¦é€šçŸ¥`,
      blocks: [
        {
          type: "header",
          text: {
            type: "plain_text",
            text: `ğŸŸ¡ CO2æ¿ƒåº¦: ${data.co2} ppm`,
            emoji: true,
          },
        },
        {
          type: "section",
          fields: [
            { type: "mrkdwn", text: `*ãƒ‡ãƒã‚¤ã‚¹å:*\n${data.deviceName}` },
            { type: "mrkdwn", text: `*ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:*\nCO2é«˜ã‚ï¼ˆæ›æ°—æ¨å¥¨ï¼‰` },
            { type: "mrkdwn", text: `*CO2æ¿ƒåº¦:*\n${data.co2} ppm` },
            { type: "mrkdwn", text: `*æ¸©åº¦:*\n${data.temperature}Â°C` },
            { type: "mrkdwn", text: `*æ¹¿åº¦:*\n${data.humidity}%` },
            { type: "mrkdwn", text: `*ãƒãƒƒãƒ†ãƒªãƒ¼:*\n${data.battery}%` },
          ],
        },
        {
          type: "context",
          elements: [{ type: "mrkdwn", text: `æ¸¬å®šæ™‚åˆ»: ${data.timestamp}` }],
        },
      ],
    }),
  });
}
```

![Slacké€šçŸ¥](https://storage.googleapis.com/zenn-user-upload/de3b9a72ce4f-20260127.png)

## cron ã®è¨­è¨ˆ

`node-cron`ã‚’åˆ©ç”¨ã—ã¦5åˆ†ã”ã¨ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
`cron.schedule`ã‚’ä½¿ã£ã¦ã€æŒ‡å®šã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å¾“ã£ã¦`job`é–¢æ•°ã‚’å®šæœŸå®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
`CRON_SCHEDULE`ã¯cronå½¢å¼ã®æ–‡å­—åˆ—ã€`TIMEZONE`ã¯å®Ÿè¡Œæ™‚ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æŒ‡å®šã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€Œã„ã¤ã€ã€Œã©ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§ã€å‡¦ç†ã‚’å›ã™ã‹ã‚’æŸ”è»Ÿã«åˆ¶å¾¡ã§ãã¾ã™ã€‚

```ts
const CRON_SCHEDULE = "*/5 * * * *"
const TIMEZONE = "Asia/Tokyo"

cron.schedule(CRON_SCHEDULE, job, {
  timezone: TIMEZONE,
});
```

ã¾ãŸpm2ã‚’åˆ©ç”¨ã—ã¦ç­†è€…ã®Macä¸Šã§ãƒ—ãƒ­ã‚»ã‚¹ãŒå¸¸é§ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€PCã®èµ·å‹•ã”ã¨ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã«è¡Œãæ‰‹é–“ãŒãªããªã‚Šã¾ã—ãŸã€‚

æ¬¡ã®ã‚ˆã†ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã€`pm2 start ecosystem.config.cjs`ã§å®Ÿè¡Œã—ã¾ã™ã€‚

```js:ecosystem.config.cjs
module.exports = {
  apps: [{
    name: 'co2-bot',
    script: './src/main.ts',
    interpreter: 'node',
    node_args: '--experimental-strip-types',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    merge_logs: true,
    cron_restart: '0 3 * * *'
  }]
};
```

åŠ ãˆã¦ã€Nodeã®`experimental-strip-types`ã‚’åˆ©ç”¨ã—ã¦TypeScriptã‚’ç›´æ¥å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

CO2æ¿ƒåº¦ã®å¯è¦–åŒ–ã«ã‚ˆã‚Šæ›æ°—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆ†ã‹ã‚Šã€é›†ä¸­ã‚’æŒç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚è¨ˆæ¸¬ã‹ã‚‰ã€1äººã§1æ™‚é–“ä½œæ¥­ã™ã‚‹ã¨660ppmç¨‹åº¦ã€2äººã§1æ™‚é–“ä½œæ¥­ã™ã‚‹ã¨1000ppmã‚’è¶…ãˆã‚‹ã“ã¨ã‚„ã€åŠ æ¹¿ã®å¿…è¦æ€§ã‚‚åˆ†ã‹ã‚Šã¾ã—ãŸã€‚ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
